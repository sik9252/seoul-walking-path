name: Weekly Tour Place Sync

on:
  schedule:
    - cron: "0 16 * * 0" # Every Monday 01:00 KST (Sunday 16:00 UTC)
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install backend deps
        run: npm ci

      - name: Run weekly tour place sync
        env:
          TOUR_API_SERVICE_KEY: ${{ secrets.TOUR_API_SERVICE_KEY }}
          TOUR_API_BASE_URL: ${{ secrets.TOUR_API_BASE_URL }}
          TOUR_API_AREA_CODE: ${{ secrets.TOUR_API_AREA_CODE }}
          TOUR_API_PAGE_SIZE: ${{ secrets.TOUR_API_PAGE_SIZE }}
          TOUR_API_TIMEOUT_MS: ${{ secrets.TOUR_API_TIMEOUT_MS }}
        run: npm run sync:tour-places

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tour-place-sync-output
          path: |
            backend/data/raw/tour-api-seoul.json
            backend/data/generated/tour-places.normalized.json
