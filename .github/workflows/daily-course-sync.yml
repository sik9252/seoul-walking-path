name: Daily Seoul Course Sync

on:
  schedule:
    - cron: "0 16 * * *" # KST 01:00
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install backend deps
        run: npm ci

      - name: Run daily sync pipeline
        env:
          SEOUL_COURSE_INFO_URL: ${{ secrets.SEOUL_COURSE_INFO_URL }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          SYNC_FAILURE_WEBHOOK_URL: ${{ secrets.SYNC_FAILURE_WEBHOOK_URL }}
        run: npm run sync:daily

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: seoul-course-sync-output
          path: |
            backend/data/raw/seoul-course-info.json
            backend/data/generated/seoul-courses.normalized.json
            backend/data/generated/course-checkpoints.geocoded.json
            backend/data/generated/course-checkpoints.upsert.sql
